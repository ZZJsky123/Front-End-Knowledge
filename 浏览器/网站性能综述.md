### 前言

Steve Souders：

```
Web 开发，那你技术体系的根基就是 Web 和它赖以存在的大量网络协议：TCP、TLS、UDP、HTTP，
等等。这些协议分别有各自的性能特点和优化技巧，为开发高性能应用，你必须理
解为什么网络那么运行。
```

Ilya Grigorik

```
大多数网站性能的瓶颈都是延迟，而不是带宽！

延迟： 分组从信息源发送到目的地所需的时间
   传播延迟：消息从发送端到接收端需要的时间，是信号传播距离和速度的函数。
   传输延迟：把消息中的所有比特转移到链路中需要的时间，是消息长度和链路速率的函数。
   处理延迟：处理分组首部、检查位错误及确定分组目标所需的时间。
   排队延迟：到来的分组排队等待处理的时间。
   
带宽： 逻辑或物理通信路径最大的吞吐量

Ookla 运营的 http://speedtest.net 可以测试客户端到某个 [本地服务器] 的上传和下载速度
```

### TCP

```
三次握手： 
    1. 客户端生成一个随机序列号x， 并发送一个 SYN 分组
    2. 服务端应答：对随机序列号x + 1 ，并生成自己随机序列号y， 追加自己的标志和选项然后返回响应。
    3. 客户端对x和y都+1， 并发送握手期间最后一个 ACK 分组

服务器端会在接收ACK分组和开始接收消息

三次握手造成很大的延迟开销。

流量控制： 
    1. TCP 连接的每一方都要通告自己的接收窗口 （rwnd），当一方需要处理速度跟不上发送端发送速度，降低
       自己的窗口大小并通知发送方，当窗口减小为0， 应用层需要首先清空缓冲区数据。
       
慢启动、拥塞预防、快速重发和快速恢复
```

### UDP

```
数据报： 完整，独立的数据实体，携带着从源节点到目的节点的足够信息， 对这些节点间之前的数据交换和传输网络没有任何依赖。一般将不可靠协议传送的数据称为数据报。

UDP应用：DNS（Domain Name System，域名系统）。DNS 负责把对人类友好的主机名转换成 IP 地址。

UDP又称为无协议服务：
         1. 不保证交付顺序：不设置包序号，不重排，不会发生队首阻塞。
         2. 不跟踪程序状态：不必建立连接或重启状态机
         3. 不保证信息交付：不确认，不重传，无超时。
         4. 没有拥塞控制：不内置客户端或网络反馈机制。
```

### TLS

```
TLS： Transport Layer Security， 位于会话层主要为应用层提供： 数据加密， 数据完整性检验， 身份验证。

数据加密： 混淆数据的机制。
身份验证： 验证身份标识有效性的机制。
完整性： 检测信息是否被篡改和伪造。
```

### HTTP 

```
HTTP： 超文本传输协议(HyberText Transfer Protocol) 是互联网最普遍采用的应用协议。

HTTP0.9： 
    1. 客户端/服务器  请求/响应
    2. ACSII协议， 运行于TCP/IP协议之上
    3. 设计用来传输超文本文档
    4. 服务器和客户端在每次的连接在请求以后都会断开

telnet google.com 80
Connect to 74.125.xxx.xxx

请求： GET/ about/
响应： (超文本文档)

请求只有一行，包括 GET 方法和要请求的文档的路径。响应是一个超文本文档，没
有首部，也没有其他元数据，只有 HTML。

HTTP1.0：
    1. 请求行加入HTTP 版本号， 请求行后可跟多行首部
    2. [响应对象]前面增加响应状态行
    3. [响应状态行]后[响应对象]前可跟多行首部
    4. 响应对象不局限于对象文本： 图片， 文件
    5. 服务器与客户端之间的连接在每次请求之后都会关闭。
    
总结： 1. 请求和响应首部都使用 ASCII 编码，但响应对象本身可以是任何类型：HTML 文
         件、纯文本文件、图片，或其他内容类型。
      2. 事实上，HTTP 中的“HTT”（Hypertext Transfer，超文本传输）在协议出现后不久就已经用词不当了。在
         实践中，HTTP 迅速发展为超媒体传输协议，但最初的名字则沿用至今。
         $> telnet website.org 80
            Connected to xxx.xxx.xxx.xxx
            GET /rfc/rfc1945.txt HTTP/1.0 ➊   请求行
            User-Agent: CERN-LineMode/2.15 libwww/2.17b3
            Accept: */*
            
            HTTP/1.0 200 OK ➋   响应状态行
            Content-Type: text/plain
            Content-Length: 137582
            Expires: Thu, 01 Dec 1997 16:00:00 GMT
            Last-Modified: Wed, 1 May 1996 12:45:26 GMT
            Server: Apache 0.84
           （纯文本响应）  响应对象
           （连接关闭）
           
HTTP1.1: 持久连接、分块编码传输、 字节范围请求、 增强的缓存机制、 传输编码/请求管道  (HTTP权威指南)

          1. 持久化连接， 引入 Connection 字段， 设置 Connection: keep-alive, 则传输
             不会在请求之后关闭，而是继续保持连接。 设置 Connection: closed 连接在请求完成
             后断开
          2. 字节范围请求： 响应对象发送之前， 会先发送字节数。
          3. 请求管道： 持久化连接使得同时会出现多个 HTTP 请求， 他们必须满足 FIFO 队列
                      请求管道使得这个队列移动到服务器端， 使得服务器端可以并行处理请求，但是
                      HTTP1.x 只支持按找 FIFO 队列顺序进出， 不允许先渲染完者直接返回。
                      
           telnet website.org 80
            Connected to xxx.xxx.xxx.xxx
            GET /index.html HTTP/1.1 ➊   
            Host: website.org
            User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_4)... (snip)
            Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
            Accept-Encoding: gzip,deflate,sdch
            Accept-Language: en-US,en;q=0.8
            Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.3
            Cookie: __qca=P0-800083390... (snip)       cookie字段 
            
            HTTP/1.1 200 OK ➋
            Server: nginx/1.0.11
            Connection: keep-alive
            Content-Type: text/html; charset=utf-8
            Via: HTTP/1.1 GWA
            Date: Wed, 25 Jul 2012 20:23:35 GMT
            Expires: Wed, 25 Jul 2012 20:23:35 GMT
            Cache-Control: max-age=0, no-cache       新的缓存字段
            Transfer-Encoding: chunked
            
            100 ➌                范围请求
            <!doctype html>
            (snip)
            100
            (snip)
            0 ➍
            
            GET /favicon.ico HTTP/1.1 ➎   相同TCP连接下， 新的数据请求
            Host: www.website.org
            User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_4)... (snip)
            Accept: */*
            Referer: http://website.org/
            Connection: close ➏           连接关闭
            Accept-Encoding: gzip,deflate,sdch
            Accept-Language: en-US,en;q=0.8
            Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.3
            Cookie: __qca=P0-800083390... (snip)
            
            HTTP/1.1 200 OK ➐
            Server: nginx/1.0.11
            Content-Type: image/x-icon
            Content-Length: 3638
            Connection: close
            Last-Modified: Thu, 19 Jul 2012 17:51:44 GMT
            Cache-Control: max-age=315360000
            Accept-Ranges: bytes
            Via: HTTP/1.1 GWA
            Date: Sat, 21 Jul 2012 21:35:22 GMT
            Expires: Thu, 31 Dec 2037 23:55:55 GMT
            Etag: W/PSA-GAu26oXbD
            
            （图标数据）
            （关闭连接）
          
总结： HTTP1.0 已经将 HTTP 协议的模板基本确定下来， HTTP1.1引入了更多的首部字段增添完善的功能：
      HTTP 1.1 协议添加了内容、编码、字符集，甚至语言的协商机制，还添加了传输编码、缓存指令、客户端    
      cookie 等十几个可以每次请求都协商的字段。

背景： 用户和 Web 开发者都迫切想要通过 HTTP 1.1 达到一种几近[实时]的响应速度和协议性能

HTTP2.0: 改变传输性能 实现低延迟高吞吐量 
 
```

### WEB 性能优化

```
1.web 性能优化： 性能优化在于弄清楚数据在传输过程中层与层之间的交互和层内的限制。
         (性能优化的很大一部分工作就是把不同层之间的交互过程分解开来，弄清楚每一层次交互的约束和限制.)

            1. 传输过程中的 [延迟] 和 [带宽] 对Web性能的影响
            2. TCP 协议对 HTTP 的传输限制
            3. HTTP 协议本身在具体场景下的限制
            4. Web 应用的发展趋势和性能需求
            5. 浏览器的局限性和优化思路

2. web 性能从文档加载时间到页面加载时间的转变：
    1. 富媒体网页的出现， 简单的文档加载变成了文档加载资源。 
    2. 页面加载时间： Page Load Time， 从视觉上是页面旋转图标旋转停止经历的时间， 从技术上定义是
                   window.onload事件被触发时的时间 ， 该事件被触发后代表 文档及依赖资源：JavaScript
                   图片、 CSS等下载完毕。
3. Web 应用把网页的简单依赖关系（在标签中使用媒体作为基本内容的补充）转换成了复杂的依赖关系：标记定义结构、样式表定义布局，而脚本构建最终的交互式应用，响应用户输入，并在交互期间创建样式表和标记。
         HTML   -- 浏览器解析 -->   DOM
                                          --->  渲染树 --> 布局  --> 绘制
         CSS    --    ？    -->   CSSOM
    javaScript 脚本会阻塞 DOM 树构建
    渲染和 CSSOM 构建又会阻塞 js 脚本运行， 因此优先将 css 文件放在页面上方，使其快速下载完毕。

WebPageTest.org 是一个开源免费的项目，可以测试世界各地网页的性能。测试用的浏览器在虚拟机中运行，可编程，可配置，有各种连接和浏览器设置可选。

4. 一个 HTTP 请求是由各个独立的阶段组成的：  DNS解析， TCP连接， TSL协商， HTTP请求， 下载资源
       
       a. 减少 DNS 查询
       b. 减少 HTTP 请求
       c. 使用 CDN 
       d. 添加 Expires 首部并配置 ETag 标签
       e. Gzip 资源
       f. 避免 HTTP 重定向
       
5. HTTP1.1 带来的性能优化：

       a.HTTP1.X 不支持多路复用， 采取打开多个 TCP 会话的方式进行
       


```

