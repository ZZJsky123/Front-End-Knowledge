## 同源策略

### 同源

```
【定义】： 协议相同、 域名相同、 端口相同 称为同源

【非同源对浏览器操作限制】：  cookie限制

                              DOM限制： 存在iframe子页面，父页面无法操作子页面DOM
                              window.postMessage(data, 'url')   url是接受消息的源 HTML5
                              提出跨窗口通信。
                              window.addEventListener('message', function (e) {
                                   console.log(e.data);
                              },false);
                            
                         AJax请求限制： 不能向非同源服务器发送Ajax请求
                        
【Ajax请求限制】： 1. JSONP : 在父页面动态创建<script>标签(document.creatElement('script'))
                           设置<script>标签的src为要访问的非同源服务器在查询字段写入？参数1=value&callback=函数名
                           将该<script>标签加入当前页面，document.body.appendChild(name);
                           服务器收到这个请求以后，会将数据以Json的格式放在回调函数的参数位置返回
     本质：.js文件不受同源策略限制，反是有src这个属性的标签都有跨域功能，服务器把数据装进js的文件中从而完成跨域。因为JSON被JS原生支持，后台同时也支持这种数据格式因此选用JSON这数据格式进行传输。
     
                2.  Websocket
                       1. 不受同源策略限制的协议，因为请求报文中含有Orign字段
                           Origin字段会指明请求源，服务器收到后会对请求源进行判断
                3.  CORS
                
                     1. 报文类型Options  请求字段： Access-control-request-Methods
                                                 Access-control-request-Headers
                                                 Access-control-request-origin : 允许的请求源
                                        响应报文： Access-Control-Allow- origin
                                                 Access-Control-Allow-Methods
                        若服务器否定请求，返回一个正常的报文，不包含CORS字段
                                                 
```

## 同源策略

```
同源策略分为两类： 

   A.  DOM 同源测略
   
   B.  AJAX 请求同源策略 ： 对不同源的资源访问的限制
```



## XMLHttpRequest 同源策略

```
1. CORS 同源策略：
    a. cors 已经被加入到 XMLHttpRequest Level 2中， 当发生跨资源请求时将自动触发 cors 策略
    
    b. cors 策略的核心是， 进行跨站资源请求时， 请求报文会添加 Origin 字段用于指明请求的源信息
       ：协议、 端口、 主机。 服务器若通过则会返回 Access-Control-Allow-Origin 字段，该字段
       的值与 Origin 字段一模一样或者是：'*'。 若没有该字段返回， [浏览器] 会识别此时跨站请求拒绝
       则会阻止响应返回。并且触发 xhr.onerror 上的回调函数， 状态码依然可能是200。
       
    c. origin 字段由浏览器全权控制， 用户不可以再浏览器上进行改写。
    
    d.   I. 简答请求：  直接向请求报文中添加 Origin 字段
    
         II. 复杂请求： 正式请求前，发送 OPTIONS 报文进行协商 

2. JSNOP 同源策略

    a. 利用 script 可以加载非同源资源的特点，进行跨站 get 请求
    
    b. function getData(data){
          console.log(data)
      }
        var script  = document.creatElement('script');
         script.src = 'https://xxx.com/path?callback=getData';
         
         document.body.appendChild(script);   
        ：服务器处理请求并将数据放入到函数中返回，浏览器收到响应后直接运行函数
```

## DOM 同源操作

```
1. hash 值

   a. 获取子窗口 window.location.href 将数据添加到链接的 fragement 部分
       url = url + '#' + data
       
   b. 重新设置子窗口的 href 此时子窗口的链接会更新触发 window.onhaschange 回调函数
      子窗口在该回调函数中 window.locaton.hash 获取数据。
      
2. window.name

3. window.postMessage：  窗口对象之间互相传递信息

     a.  获取待发送信息的窗口对象 window.getElementById('').contentWindow  subWindow
     
     b. 发送信息：subWindow.postMessage( data,  subWindow 的 url)
     
     c. 监听： window.addEventListener('message', function(e){ console.log(e.data)});
     
     d. e 有三个属性：  e.origin: 目标源   e.source: 发送信息的源   e.data  
```

